name: Build and Deploy Microservices

on:
  push:
    branches: [main, develop]
    paths:
      - "backend/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/**"

env:
  REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      booking-service: ${{ steps.changes.outputs.booking-service }}
      trip-service: ${{ steps.changes.outputs.trip-service }}
      user-service: ${{ steps.changes.outputs.user-service }}

      gateway-service: ${{ steps.changes.outputs.gateway-service }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            booking-service:
              - 'backend/booking-service/**'
              - 'backend/shared/**'
            trip-service:
              - 'backend/trip-service/**'
              - 'backend/shared/**'
            user-service:
              - 'backend/user-service/**'
              - 'backend/shared/**'

            gateway-service:
              - 'backend/gateway-service/**'
              - 'backend/shared/**'
            shared:
              - 'backend/shared/**'

  build-and-push:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.booking-service == 'true' ||
      needs.detect-changes.outputs.trip-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.gateway-service == 'true'
    runs-on: ubuntu-latest
    environment: Production
    strategy:
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
            port: 8082
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
            port: 8081
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}
            port: 8080
          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}
            port: 8000
    steps:
      - name: Checkout code
        if: matrix.service.changed == 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: matrix.service.changed == 'true'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.0
            network=host

      - name: Login to Docker Hub
        if: matrix.service.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: Extract metadata
        if: matrix.service.changed == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/bus-booking-${{ matrix.service.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        if: matrix.service.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/${{ matrix.service.name }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SERVICE_PORT=${{ matrix.service.port }}

      - name: Update ArgoCD Application
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main' && vars.ARGOCD_SERVER != ''
        run: |
          # Update image tag in ArgoCD application
          NEW_TAG="${{ github.ref_name }}-${{ github.sha }}"
          echo "Updating ${{ matrix.service.name }} to tag: $NEW_TAG"
          echo "ArgoCD Server: ${{ vars.ARGOCD_SERVER }}"

          # Only sync if ArgoCD is configured
          if [ -n "${{ vars.ARGOCD_SERVER }}" ] && [ -n "${{ secrets.ARGOCD_TOKEN }}" ]; then
            curl -X POST \
              -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"revision": "HEAD"}' \
              "${{ vars.ARGOCD_SERVER }}/api/v1/applications/bus-booking-${{ matrix.service.name }}/sync"
          else
            echo "ArgoCD not configured, skipping sync"
          fi

  security-scan:
    needs: [detect-changes, build-and-push]
    if: false # Disabled temporarily for faster builds
    runs-on: ubuntu-latest
    environment: Production
    strategy:
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}

          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}

    steps:
      - name: Login to Docker Hub
        if: matrix.service.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: Run Trivy vulnerability scanner
        if: matrix.service.changed == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.DOCKER_USERNAME }}/bus-booking-${{ matrix.service.name }}:${{ github.ref_name }}-${{ github.sha }}"
          format: "sarif"
          output: "trivy-results-${{ matrix.service.name }}.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: matrix.service.changed == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results-${{ matrix.service.name }}.sarif"

  notify:
    needs: [detect-changes, build-and-push, security-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate deployment summary
        run: |
          echo "## ðŸš€ Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Changed:" >> $GITHUB_STEP_SUMMARY
          echo "- **booking-service**: ${{ needs.detect-changes.outputs.booking-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **trip-service**: ${{ needs.detect-changes.outputs.trip-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **user-service**: ${{ needs.detect-changes.outputs.user-service }}" >> $GITHUB_STEP_SUMMARY

          echo "- **gateway-service**: ${{ needs.detect-changes.outputs.gateway-service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build & Push**: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images:" >> $GITHUB_STEP_SUMMARY
          echo "Tag: \`${{ github.ref_name }}-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment status
        run: |
          echo "Deployment pipeline completed"
          echo "Build status: ${{ needs.build-and-push.result }}"
          echo "Security scan: ${{ needs.security-scan.result }}"
