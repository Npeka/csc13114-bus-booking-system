name: Build and Deploy Microservices

# NOTE: This workflow runs AFTER quality-checks.yml completes successfully.
# Quality checks (linting, formatting, tests) must pass before build and deploy.

on:
  push:
    branches: [main, develop]
    paths:
      - "backend/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/**"  
  workflow_run:
    workflows: ["Quality Checks"]
    types: [completed]
    branches: [main, develop]

permissions:
  contents: write # Required to push to infra branch
  packages: write # Required for Docker Hub operations
  actions: read # Required for workflow operations
  security-events: write # Required for security scan uploads

env:
  REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
  INFRA_DEPLOY_TOKEN: ${{ secrets.INFRA_DEPLOY_TOKEN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      booking-service: ${{ steps.changes.outputs.booking-service }}
      gateway-service: ${{ steps.changes.outputs.gateway-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      trip-service: ${{ steps.changes.outputs.trip-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            booking-service:
              - 'backend/booking-service/**'
              - 'backend/shared/**'
            gateway-service:
              - 'backend/gateway-service/**'
              - 'backend/shared/**'
            payment-service:
              - 'backend/payment-service/**'
              - 'backend/shared/**'
            trip-service:
              - 'backend/trip-service/**'
              - 'backend/shared/**'
            user-service:
              - 'backend/user-service/**'
              - 'backend/shared/**'
            shared:
              - 'backend/shared/**'

  build-and-push:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.booking-service == 'true' ||
      needs.detect-changes.outputs.gateway-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.trip-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: Production
    strategy:
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
            port: 8080
          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}
            port: 8080
          - name: payment-service
            changed: ${{ needs.detect-changes.outputs.payment-service }}
            port: 8080
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
            port: 8080
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}
            port: 8080
    steps:
      - name: Checkout main branch for build
        if: matrix.service.changed == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Docker Buildx
        if: matrix.service.changed == 'true'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.0
            network=host

      - name: Login to Docker Hub
        if: matrix.service.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: Generate image tags
        if: matrix.service.changed == 'true'
        id: meta
        run: |
          # Generate short commit tag (7 characters)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          SERVICE_TAG="${{ matrix.service.name }}-${SHORT_SHA}"
          IMAGE_NAME="${{ env.DOCKER_USERNAME }}/bb-${{ matrix.service.name }}"

          # Set output tags
          echo "tags=${IMAGE_NAME}:${SERVICE_TAG},${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tag=${SERVICE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          echo "ðŸ·ï¸  Generated tags:"
          echo "   - ${IMAGE_NAME}:${SERVICE_TAG}"
          echo "   - ${IMAGE_NAME}:latest"

      - name: Build and push Docker image
        if: matrix.service.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/${{ matrix.service.name }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64
          # cache-from: type=gha  # Disabled due to GitHub Actions Cache service outage
          # cache-to: type=gha,mode=max  # Disabled due to GitHub Actions Cache service outage
          build-args: |
            SERVICE_PORT=${{ matrix.service.port }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Update Infrastructure Repository
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        run: |
          # Set up variables
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          SERVICE_TAG="${{ matrix.service.name }}-${SHORT_SHA}"
          SERVICE_NAME="${{ matrix.service.name }}"
          IMAGE_NAME="${{ env.DOCKER_USERNAME }}/bb-${SERVICE_NAME}:${SERVICE_TAG}"

          echo "Updating ${SERVICE_NAME} to image: ${IMAGE_NAME}"
          echo "Short SHA: ${SHORT_SHA}"
          echo "Service Tag: ${SERVICE_TAG}"

          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Set up GitHub token for pushing to infra branch
          git remote set-url origin https://x-access-token:${{ env.INFRA_DEPLOY_TOKEN }}@github.com/${{ github.repository }}.git

          # Switch to infra branch
          git fetch origin infra
          git checkout infra

          # Update Helm values.yaml with new image tag for specific service
          if [ -f "helm/bus-booking/values.yaml" ]; then
            # Update image tag in main values.yaml file using service-specific path
            sed -i "/^  ${SERVICE_NAME}:/,/^  [a-zA-Z]/ s|tag: .*|tag: ${SERVICE_TAG}|" helm/bus-booking/values.yaml
            echo "âœ… Updated helm/bus-booking/values.yaml with ${SERVICE_NAME} tag: ${SERVICE_TAG}"
          else
            echo "âš ï¸  Main values file not found: helm/bus-booking/values.yaml"
          fi

          # Commit and push changes
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${SERVICE_NAME} image to ${SERVICE_TAG}
            
            - Service: ${SERVICE_NAME}
            - Image: ${IMAGE_NAME}
            - Short SHA: ${SHORT_SHA}
            - Full Commit: ${{ github.sha }}"
            
            git push origin infra
            echo "âœ… Updated infra branch with new image tag"
          fi

  security-scan:
    needs: [detect-changes, build-and-push]
    if: false # Disabled temporarily for faster builds
    runs-on: ubuntu-latest
    environment: Production
    strategy:
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}
          - name: payment-service
            changed: ${{ needs.detect-changes.outputs.payment-service }}
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}

    steps:
      - name: Login to Docker Hub
        if: matrix.service.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: Run Trivy vulnerability scanner
        if: matrix.service.changed == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.DOCKER_USERNAME }}/bus-booking-${{ matrix.service.name }}:${{ github.ref_name }}-${{ github.sha }}"
          format: "sarif"
          output: "trivy-results-${{ matrix.service.name }}.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: matrix.service.changed == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results-${{ matrix.service.name }}.sarif"

  notify:
    needs: [detect-changes, build-and-push, security-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate deployment summary
        run: |
          COMMIT_TAG="${{ github.ref_name }}-${{ github.sha }}"

          echo "## ðŸš€ Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Changed:" >> $GITHUB_STEP_SUMMARY
          echo "- **booking-service**: ${{ needs.detect-changes.outputs.booking-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **gateway-service**: ${{ needs.detect-changes.outputs.gateway-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **payment-service**: ${{ needs.detect-changes.outputs.payment-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **trip-service**: ${{ needs.detect-changes.outputs.trip-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **user-service**: ${{ needs.detect-changes.outputs.user-service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build & Push**: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images:" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: \`${COMMIT_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Update:" >> $GITHUB_STEP_SUMMARY
          echo "- Updated **infra** branch with new image tags" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD will detect changes and deploy automatically" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment status
        run: |
          echo "Deployment pipeline completed"
          echo "Build status: ${{ needs.build-and-push.result }}"
          echo "Security scan: ${{ needs.security-scan.result }}"
