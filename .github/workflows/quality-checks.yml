name: Quality Checks

on:
  push:
    branches: [main, develop]
    paths:
      - "frontend/**"
      - "backend/**"
      - ".github/workflows/quality-checks.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "frontend/**"
      - "backend/**"
      - ".github/workflows/quality-checks.yml"

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      booking-service: ${{ steps.changes.outputs.booking-service }}
      gateway-service: ${{ steps.changes.outputs.gateway-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      trip-service: ${{ steps.changes.outputs.trip-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3.0.2
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            booking-service:
              - 'backend/booking-service/**'
              - 'backend/shared/**'
            gateway-service:
              - 'backend/gateway-service/**'
              - 'backend/shared/**'
            payment-service:
              - 'backend/payment-service/**'
              - 'backend/shared/**'
            trip-service:
              - 'backend/trip-service/**'
              - 'backend/shared/**'
            user-service:
              - 'backend/user-service/**'
              - 'backend/shared/**'
            shared:
              - 'backend/shared/**'

  frontend-quality:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Type check
        working-directory: frontend
        run: pnpm run type-check

      - name: Lint check
        working-directory: frontend
        run: pnpm run lint:check

      - name: Format check
        working-directory: frontend
        run: pnpm run format:check

      - name: Summary
        if: always()
        run: |
          {
            echo "## Frontend Quality Checks"
            echo
            echo "- Type check: completed"
            echo "- Lint: completed"
            echo "- Format check: completed"
          } >> "$GITHUB_STEP_SUMMARY"

  backend-quality:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.booking-service == 'true' ||
      needs.detect-changes.outputs.gateway-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.trip-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}
          - name: payment-service
            changed: ${{ needs.detect-changes.outputs.payment-service }}
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}

    steps:
      - name: Checkout code
        if: matrix.service.changed == 'true'
        uses: actions/checkout@v4

      - name: Setup Go
        if: matrix.service.changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache-dependency-path: backend/${{ matrix.service.name }}/go.sum

      - name: Install golangci-lint
        if: matrix.service.changed == 'true'
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
            | sh -s -- -b "$(go env GOPATH)/bin" v2.6.2
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Download dependencies
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: go mod download

      - name: Format check
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make fmt-check

      - name: Go vet
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make vet

      - name: Lint
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make lint

      - name: Run tests
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make test

      - name: Summary
        if: matrix.service.changed == 'true' && always()
        run: |
          {
            echo "## Backend Quality - ${{ matrix.service.name }}"
            echo
            echo "- Format check: completed"
            echo "- Go vet: completed"
            echo "- Lint: completed"
            echo "- Tests: completed"
          } >> "$GITHUB_STEP_SUMMARY"

  quality-summary:
    needs: [detect-changes, frontend-quality, backend-quality]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Quality summary
        run: |
          {
            echo "## Quality Checks Summary"
            echo
            echo "### Changes detected"
            echo "- Frontend: ${{ needs.detect-changes.outputs.frontend }}"
            echo "- booking-service: ${{ needs.detect-changes.outputs.booking-service }}"
            echo "- gateway-service: ${{ needs.detect-changes.outputs.gateway-service }}"
            echo "- payment-service: ${{ needs.detect-changes.outputs.payment-service }}"
            echo "- trip-service: ${{ needs.detect-changes.outputs.trip-service }}"
            echo "- user-service: ${{ needs.detect-changes.outputs.user-service }}"
            echo "- shared: ${{ needs.detect-changes.outputs.shared }}"
            echo
            echo "### Job results"
            echo "- Frontend quality job: ${{ needs.frontend-quality.result }}"
            echo "- Backend quality job: ${{ needs.backend-quality.result }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if quality checks failed
        if: |
          needs.frontend-quality.result == 'failure' ||
          needs.backend-quality.result == 'failure'
        run: |
          echo "Quality checks failed."
          exit 1
