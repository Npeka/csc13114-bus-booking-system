name: Backend Quality, Build & Deploy

on:
  push:
    branches: [main, develop]
    paths:
      - "backend/**"
      - ".github/workflows/backend-pipeline.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/**"
      - ".github/workflows/backend-pipeline.yml"

permissions:
  contents: write # Required to push to infra branch
  packages: write # Required for Docker Hub operations
  actions: read
  security-events: write

env:
  REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
  INFRA_DEPLOY_TOKEN: ${{ secrets.INFRA_DEPLOY_TOKEN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      booking-service: ${{ steps.changes.outputs.booking-service }}
      gateway-service: ${{ steps.changes.outputs.gateway-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      trip-service: ${{ steps.changes.outputs.trip-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3.0.2
        id: changes
        with:
          filters: |
            booking-service:
              - 'backend/booking-service/**'
              - 'backend/shared/**'
            gateway-service:
              - 'backend/gateway-service/**'
              - 'backend/shared/**'
            payment-service:
              - 'backend/payment-service/**'
              - 'backend/shared/**'
            trip-service:
              - 'backend/trip-service/**'
              - 'backend/shared/**'
            user-service:
              - 'backend/user-service/**'
              - 'backend/shared/**'
            shared:
              - 'backend/shared/**'

  # Quality checks per service - runs independently
  ci:
    name: ${{ matrix.service.changed == 'true' && format('âœ“ CI - {0}', matrix.service.name) || format('âŠ˜ CI - {0} (skipped)', matrix.service.name) }}
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.booking-service == 'true' ||
      needs.detect-changes.outputs.gateway-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.trip-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Each service runs independently
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}
          - name: payment-service
            changed: ${{ needs.detect-changes.outputs.payment-service }}
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}
    outputs:
      booking-service-quality: ${{ steps.quality-result.outputs.booking-service }}
      gateway-service-quality: ${{ steps.quality-result.outputs.gateway-service }}
      payment-service-quality: ${{ steps.quality-result.outputs.payment-service }}
      trip-service-quality: ${{ steps.quality-result.outputs.trip-service }}
      user-service-quality: ${{ steps.quality-result.outputs.user-service }}

    steps:
      - name: Checkout code
        if: matrix.service.changed == 'true'
        uses: actions/checkout@v4

      - name: Setup Go
        if: matrix.service.changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache-dependency-path: backend/${{ matrix.service.name }}/go.sum

      - name: Install golangci-lint
        if: matrix.service.changed == 'true'
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
            | sh -s -- -b "$(go env GOPATH)/bin" v2.6.2
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Download dependencies
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: go mod download

      - name: Format check
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make fmt-check

      - name: Go vet
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make vet

      - name: Lint
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make lint

      - name: Run tests
        if: matrix.service.changed == 'true'
        working-directory: backend/${{ matrix.service.name }}
        run: make test

      - name: Set quality result
        id: quality-result
        if: matrix.service.changed == 'true'
        run: echo "${{ matrix.service.name }}=success" >> $GITHUB_OUTPUT

      - name: Summary
        if: matrix.service.changed == 'true' && always()
        run: |
          {
            echo "## Quality Check - ${{ matrix.service.name }}"
            echo
            echo "- Format check: completed"
            echo "- Go vet: completed"
            echo "- Lint: completed"
            echo "- Tests: completed"
          } >> "$GITHUB_STEP_SUMMARY"

  # Build and deploy - only if quality checks pass for that service
  cd:
    name: ${{ matrix.service.changed == 'true' && format('âœ“ CD - {0}', matrix.service.name) || format('âŠ˜ CD - {0} (skipped)', matrix.service.name) }}
    needs: [detect-changes, ci]
    if: |
      needs.detect-changes.outputs.booking-service == 'true' ||
      needs.detect-changes.outputs.gateway-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.trip-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: Production
    strategy:
      fail-fast: false # Each service deploys independently
      matrix:
        service:
          - name: booking-service
            changed: ${{ needs.detect-changes.outputs.booking-service }}
            port: 8080
          - name: gateway-service
            changed: ${{ needs.detect-changes.outputs.gateway-service }}
            port: 8080
          - name: payment-service
            changed: ${{ needs.detect-changes.outputs.payment-service }}
            port: 8080
          - name: trip-service
            changed: ${{ needs.detect-changes.outputs.trip-service }}
            port: 8080
          - name: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}
            port: 8080

    steps:
      - name: Check if quality passed
        if: matrix.service.changed == 'true'
        id: quality-check
        run: |
          # Only proceed if quality checks passed for this service
          echo "Quality check status for ${{ matrix.service.name }}: ${{ needs.ci.result }}"
          if [ "${{ needs.ci.result }}" != "success" ]; then
            echo "Quality checks failed for ${{ matrix.service.name }}, skipping build and deploy"
            exit 1
          fi

      - name: Checkout main branch
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Docker Buildx
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.0
            network=host

      - name: Login to Docker Hub
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: Generate image tags
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          SERVICE_TAG="${{ matrix.service.name }}-${SHORT_SHA}"
          IMAGE_NAME="${{ env.DOCKER_USERNAME }}/bb-${{ matrix.service.name }}"

          echo "tags=${IMAGE_NAME}:${SERVICE_TAG},${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tag=${SERVICE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          echo "ðŸ·ï¸  Generated tags:"
          echo "   - ${IMAGE_NAME}:${SERVICE_TAG}"
          echo "   - ${IMAGE_NAME}:latest"

      - name: Build and push Docker image
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/${{ matrix.service.name }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64
          build-args: |
            SERVICE_PORT=${{ matrix.service.port }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Update Infrastructure Repository
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main'
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          SERVICE_TAG="${{ matrix.service.name }}-${SHORT_SHA}"
          SERVICE_NAME="${{ matrix.service.name }}"
          IMAGE_NAME="${{ env.DOCKER_USERNAME }}/bb-${SERVICE_NAME}:${SERVICE_TAG}"

          echo "Updating ${SERVICE_NAME} to image: ${IMAGE_NAME}"

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${{ env.INFRA_DEPLOY_TOKEN }}@github.com/${{ github.repository }}.git

          git fetch origin infra
          git checkout infra

          if [ -f "helm/bus-booking/values.yaml" ]; then
            sed -i "/^  ${SERVICE_NAME}:/,/^  [a-zA-Z]/ s|tag: .*|tag: ${SERVICE_TAG}|" helm/bus-booking/values.yaml
            echo "âœ… Updated helm/bus-booking/values.yaml with ${SERVICE_NAME} tag: ${SERVICE_TAG}"
          else
            echo "âš ï¸  Main values file not found: helm/bus-booking/values.yaml"
          fi

          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${SERVICE_NAME} image to ${SERVICE_TAG}
            
            - Service: ${SERVICE_NAME}
            - Image: ${IMAGE_NAME}
            - Short SHA: ${SHORT_SHA}
            - Full Commit: ${{ github.sha }}"
            
            git push origin infra
            echo "âœ… Updated infra branch with new image tag"
          fi

      - name: Deployment summary
        if: matrix.service.changed == 'true' && github.ref == 'refs/heads/main' && always()
        run: |
          {
            echo "## ðŸš€ Deployment - ${{ matrix.service.name }}"
            echo
            echo "- Quality checks: âœ… Passed"
            echo "- Docker build: âœ… Completed"
            echo "- Image pushed: \`${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}\`"
            echo "- Infrastructure updated: âœ… Completed"
          } >> "$GITHUB_STEP_SUMMARY"

  # Summary job
  pipeline-summary:
    needs: [detect-changes, ci, cd]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline summary
        run: |
          {
            echo "## Backend Pipeline Summary"
            echo
            echo "### Services Changed:"
            echo "- **booking-service**: ${{ needs.detect-changes.outputs.booking-service }}"
            echo "- **gateway-service**: ${{ needs.detect-changes.outputs.gateway-service }}"
            echo "- **payment-service**: ${{ needs.detect-changes.outputs.payment-service }}"
            echo "- **trip-service**: ${{ needs.detect-changes.outputs.trip-service }}"
            echo "- **user-service**: ${{ needs.detect-changes.outputs.user-service }}"
            echo
            echo "### Pipeline Results:"
            echo "- **CI (Quality Checks)**: ${{ needs.ci.result }}"
            echo "- **CD (Build & Deploy)**: ${{ needs.cd.result }}"
            echo
            echo "### Notes:"
            echo "- Each service runs independently"
            echo "- Failed quality checks prevent deployment for that service only"
            echo "- Other services continue normally"
          } >> "$GITHUB_STEP_SUMMARY"
